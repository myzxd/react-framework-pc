"use strict";(self.webpackChunkaoaoBoss=self.webpackChunkaoaoBoss||[]).push([[6544],{46544:function(e,t,r){r.r(t);r(52560);var o=r(71577),n=(r(51838),r(48086)),a=r(15671),s=r(43144),i=r(97326),c=r(60136),l=r(82963),p=r(61120),u=r(4942),m=(r(9070),r(20924)),f=r(94315),d=r.n(f),y=r(96486),v=r.n(y),b=r(30381),h=r.n(b),Z=r(67294),C=r(66939),g=(r(98703),r(55609)),x=r(93517),E=r.n(x),I=r(97116),F=r(80385),D=r(67442),P=r(55509),T=r(75314),S=r(51872),O=r(88144),Y=r(96036),N=r(24986),j=r(28501),A=r(89690),k=r(81170);function V(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function w(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?V(Object(r),!0).forEach((function(t){(0,u.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):V(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function L(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,o=(0,p.Z)(e);if(t){var n=(0,p.Z)(this).constructor;r=Reflect.construct(o,arguments,n)}else r=o.apply(this,arguments);return(0,l.Z)(this,r)}}var M=m.Z.TextArea,q=function(e){(0,c.Z)(r,e);var t=L(r);function r(e){var o;(0,a.Z)(this,r),o=t.call(this,e),(0,u.Z)((0,i.Z)(o),"onSuccessCallback",(function(){var e=o.props.location.query.approvalKey;o.props.history.push("/Expense/Manage/ExamineOrder/Form?orderId=".concat(o.state.orderId,"&approvalKey=").concat(e))})),(0,u.Z)((0,i.Z)(o),"onFailureCallback",(function(e){var t=e.records||[];if(d().existy(e.zh_message)&&d().not.empty(e.zh_message))return n.ZP.error(e.zh_message);t.map((function(e){return n.ZP.error(e.zh_message)}))})),(0,u.Z)((0,i.Z)(o),"onVerifyExpenseCostItems",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;if(d().empty(e))return n.ZP.error("分摊数据为空"),!0;if(d().not.array(e))return n.ZP.error("分摊数据格式错误"),!0;var a={vendor:"分摊信息供应商未选择",platform:"分摊信息平台未选择",city:"分摊信息城市未选择",district:"分摊信息商圈未选择",costCount:"分摊金额不能为空"};Number(r)===F.F$Y.team&&o!==F.F$Y.headquarters&&(a.teamType="团队类型未选择",a.teamId="团队ID未选择"),Number(r)===F.F$Y.team&&o===F.F$Y.headquarters&&(a.teamId="团队未选择"),Number(r)===F.F$Y.person&&(a.staffId="个人信息未选择",a.staffName="档案ID未选择");var s=!1,i=!1;return e.forEach((function(e,r){!0!==s&&(d().empty(e)&&(i=!0),Number(t)!==F.eL2.custom||!d().not.existy(e.costCount)&&0!==e.costCount||(s=!0,n.ZP.error("第".concat(r+1,"条分摊明细 : ").concat(a.costCount))),Object.keys(e).forEach((function(t){d().not.existy(a[t])||!0===s||(d().not.existy(e[t])||d().empty(e[t]))&&(s=!0,n.ZP.error("第".concat(r+1,"条分摊明细 : ").concat(a[t])))})))})),!0===i?n.ZP.error("分摊数据为空"):!0===s})),(0,u.Z)((0,i.Z)(o),"onChangeFilterDiffDay",(function(e){var t=h()(e[0],"YYYY-MM-DD HH:00"),r=h()(e[1],"YYYY-MM-DD HH:00").diff(t,"day"),o=0;return r>=0?(Array.from({length:r}).forEach((function(){o+=1})),o):"--"})),(0,u.Z)((0,i.Z)(o),"onSubmit",(function(){o.props.form.validateFields((function(e,t){if(!e){var r=t.expense,a=r.costItems,s=r.costBelong,i=t.costAttribution,c=void 0===i?void 0:i,l=t.costCenterType;if(!0===o.onVerifyExpenseCostItems(t.expense.costItems,s,c,l))return n.ZP.error("分摊数据为空");var p=a.map((function(e){return v().omit(e,["cityName","platformName","vendorName","districtName"])}));Number(s)===F.eL2.custom&&(p=a.map((function(e){return v().omit(e,["cityName","platformName","vendorName","districtName","costCount"])})));var u=v().uniqWith(p,v().isEqual);if(p.length!==u.length)return n.ZP.error("成本分摊不能设置相同的成本归属");var m={costBelong:s,costItems:a.map((function(e){var t=w({},e);return d().existy(e.costCount)&&d().not.empty(e.costCount)&&(t.costCount=e.costCount),t}))},f=Object.values(t.bizExtraData).map((function(e){return 100*e})).reduce((function(e,t){return e+t}))/100;if(f!==t.money)return n.ZP.error("差旅费用明细总和和费用金额不相等，请修改！");var y={};for(var b in t.bizExtraData)y[b]=F.fbc.exchangePriceToCent(t.bizExtraData[b]);var Z={orderId:o.state.orderId,records:[w(w({},t),{},{expense:m,storage_type:3,expenseType:o.state.expenseTypeId,actualApplyDays:o.onChangeFilterDiffDay(t.date),actualStartAt:h()(t.date[0]).format("YYYY-MM-DD HH:00:00"),actualDoneAt:h()(t.date[1]).format("YYYY-MM-DD HH:00:00"),bizExtraData:y,fileList:o.state.fileList})],onSuccessCallback:o.onSuccessCallback,onFailureCallback:o.onFailureCallback};if(Z.records[0].actualStartAt===Z.records[0].actualDoneAt)return n.ZP.error("开始时间与结束时间不能完全相同");o.props.dispatch({type:"expenseCostOrder/createCostOrder",payload:Z})}}))})),(0,u.Z)((0,i.Z)(o),"onChangeSubject",(function(e,t){var r=o.state.costAttribution;o.setState({selectedSubjectId:e,selectedCostCenterType:t,costAttribution:e?r:void 0}),o.props.form.setFieldsValue({costCenterType:t})})),(0,u.Z)((0,i.Z)(o),"onChangeCostAttribution",(function(e,t){var r=o.props.form,n=e.cost_center_type,a=void 0===n?void 0:n,s=e.team_type_list,i=void 0===s?[]:s;o.setState({costAttribution:a,teamTypeList:i});var c=r.getFieldsValue(["expense"]).expense||{},l=c.costBelong,p=void 0===l?void 0:l,u=c.costItems,m=void 0===u?[]:u;void 0===p&&e!==F.F$Y.person&&(p=F.eL2.average),r.setFieldsValue({expense:{costBelong:p,costItems:t?m:[{}]}})})),(0,u.Z)((0,i.Z)(o),"onUploadSuccess",(function(e){var t=o.state.fileList;t.push(e),o.setState({fileList:t})})),(0,u.Z)((0,i.Z)(o),"onDeleteFile",(function(e){var t=o.state.fileList;t.splice(e,1),o.setState(w(w({},o.state),{},{fileList:t})),o.props.form.setFieldsValue({fileList:t})})),(0,u.Z)((0,i.Z)(o),"getPlatFormVendor",(function(e){o.setState({apportionData:e},(function(){o.props.form.resetFields("invoiceTitle")}))})),(0,u.Z)((0,i.Z)(o),"renderBasics",(function(){var e=I.Iq.account.name,t=[{label:"费用分组",form:o.state.expenseTypeName},{label:"申请人",form:e||"--"}];return Z.createElement(Y.IT,{title:"基础信息"},Z.createElement(Y.KP,{items:t,cols:2}))})),(0,u.Z)((0,i.Z)(o),"renderExpenseInfo",(function(){var e=o.props.form.getFieldDecorator,t=o.state,r=t.detail,n=t.fileList,a=void 0===n?[]:n,s=t.selectedSubjectId,i=t.expenseTypeId,c=t.selectedCostCenterType,l=t.apportionData,p=t.costAttribution,u=t.teamTypeList,m=t.platform;if(i){var f=[c===F.F$Y.headquarters?{label:"发票抬头",layout:{labelCol:{span:3},wrapperCol:{span:9}},form:e("invoiceTitle",{initialValue:E().get(r,"invoiceTitle",void 0)})(Z.createElement(A.Z,{platform:"zongbu"}))}:{label:"发票抬头",layout:{labelCol:{span:3},wrapperCol:{span:9}},form:e("invoiceTitle",{initialValue:l.vendorName})(Z.createElement(O.o2,{platforms:l.platform,allowClear:!0,showSearch:!0,optionFilterProp:"children",placeholder:"请选择供应商",isSubmitNameAsValue:!0}))},{label:"备注",form:e("note",{initialValue:E().get(r,"note",void 0)})(Z.createElement(M,{rows:2}))},{label:"上传附件",form:Z.createElement("div",null,Z.createElement(N.Z,{domain:"cost",namespace:o.private.namespace,onSuccess:o.onUploadSuccess,onFailure:o.onUploadFailure}),a.map((function(e,t){return Z.createElement("p",{key:t},e,Z.createElement("span",{onClick:function(){o.onDeleteFile(t)},className:k.Z["app-comp-expense-create-files-del-btn"]},"删除"))})))}];return Z.createElement(Y.IT,{title:"项目信息"},e("subject",{initialValue:void 0})(Z.createElement(T.Z,{selectedSubjectId:s,expenseTypeId:i,form:o.props.form,platform:m,onChangeSubject:o.onChangeSubject,onChangeCostAttribution:o.onChangeCostAttribution})),e("expense",{initialValue:{}})(Z.createElement(S.Z,{costAccountingId:s,selectedCostCenterType:c,getPlatFormVendor:o.getPlatFormVendor,form:o.props.form,costAttribution:p,teamTypeList:u,platform:m})),Z.createElement(Y.KP,{items:f,cols:1,layout:{labelCol:{span:3},wrapperCol:{span:21}}}))}})),(0,u.Z)((0,i.Z)(o),"renderPaymentInfo",(function(){var e=o.props.form,t=void 0===e?{}:e,r=o.state.detail;return Z.createElement(j.Z,{form:t,detail:r,totalMoney:t.getFieldValue("money")})})),(0,u.Z)((0,i.Z)(o),"renderHiddenForm",(function(){var e=o.state.selectedCostCenterType,t=[{label:"",form:o.props.form.getFieldDecorator("costCenterType",{initialValue:e})(Z.createElement(m.Z,{hidden:!0}))}];return Z.createElement(Y.KP,{className:k.Z["app-comp-expense-manage-create-form-hide"],items:t,cols:1,layout:{labelCol:{span:2},wrapperCol:{span:22}}})}));var s=E().get(e,"location.query.expenseTypeId",""),c=E().get(e,"location.query.expenseTypeName",""),l=E().get(e,"location.query.orderId",""),p=E().get(e,"location.query.platform","");return o.state={fileList:[],selectedSubjectId:"",orderId:l,expenseTypeId:s,expenseTypeName:c,selectedCostCenterType:void 0,apportionData:{},costAllocation:void 0,teamTypeList:[],platform:p},o.private={namespace:"namespace".concat(Math.floor(1e5*Math.random())),flag:!0},o}return(0,s.Z)(r,[{key:"componentWillUnmount",value:function(){this.props.form.resetFields()}},{key:"render",value:function(){return Z.createElement(C.Z,{layout:"horizontal"},this.renderBasics(),Z.createElement(D.Z,{form:this.props.form}),Z.createElement(P.Z,{form:this.props.form}),this.renderExpenseInfo(),this.renderPaymentInfo(),this.renderHiddenForm(),Z.createElement("div",{className:k.Z["app-comp-expense-create-operate-wrap"]},Z.createElement(o.Z,{type:"primary",onClick:this.onSubmit},"提交")))}}]),r}(Z.Component);t.default=(0,g.connect)()(C.Z.create()(q))}}]);